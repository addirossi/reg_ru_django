# **Развертывание проекта на шаблоне Django**

## **1. Заказ сервера**


 1.1. Авторизуйтесь на страницу "Виртуальные серверы"
 
 1.2. Нажмите кнопку **"Новый сервер"**

 ![Кнопка "+ Новый сервер"](/images/new_server.png) 

 1.3. В открывшемся окне, в разделе **"Образы"** перейдите на вкладку **"Приложения и панели управления"** и выберите пункт **"Django"**

 ![Образ Django](/images/server_image.jpg)

 1.4. Выберите подходящий тариф в разделе **"Тарифы"**
 
 ![Тарифы](/images/tarif.jpg)

 1.5. Добавьте новый ssh-ключ в разделе **"Настройки"** или выберите из уже добавленных

 ![Настройки](/images/settings.jpg)

 1.6. После задания всех настроек, нажмите на кнопку "Заказать сервер" в правом углу экрана

 ![Заказать сервер](/images/order.jpg)

 1.7. Дождитесь создания сервера, статус изменится на *"**Активен**"*

 ![Статус](/images/server_done.jpg)

 1.8. На Ваш адрес электронной почты придёт письмо с доступами к серверу (логин, пароль, IP адрес)

 ![Доступы](/images/credentials.jpg)

 Теперь Вы можете осуществить подключение к серверу при помощи SSH


## **2. Подключение к серверу**


2.1. В командной строке подключитесь к серверу при помощи доступов, которые пришли Вам на почту

Для этого введите команду:

```bash
ssh <имя_пользователя>@<ip_адрес>
```

2.2. При подключении к серверу, Вы увидите сообщение с параметрами сервера
![Подключение к серверу](/images/connected.jpg)

Данное сообщение содержит следующие параметры:

* параметры подключения к БД
![Доступы БД](/images/db_credentials.jpg)
* доменное имя и ip-адрес созданного сервера
![Домен и IP](/images/domain_ip.jpg)
* доступы в административную панель
![Доступы к админке](/images/admin_credentials.jpg)
* имя пользователя и пароль для подключения по SSH/FTP
![Доступы SSH](/images/ssh_credentials.jpg)

2.3. Перейдите в домашнюю директорию пользователя django

```bash
cd /home/django
```

В данной директории есть папка `django_venv`, в которой находится проект и виртуальное окружение.

Файлы проекта, manage.py и статика находятся в папке src. Перейдите в эту папку
```bash
cd /home/django/django_venv/src/
```

и удалите всё содержимое этой папки
```bash
rm -rf django_project/
rm manage.py
rm -rf static/
```

Теперь Вы можете скачивать в данную папку свой проект.

## **3. Скачивание проекта на сервер**

3.1. Скопируйте ссылку HTTPS из репозитория.
![Ссылка для clone](/images/clone_link.jpg)

3.2. Склонируйте файлы в текущую папку. Для того, чтобы не создавалась лишняя папка, можно поставить в конце команды точку
```bash
git clone <ссылка> .
```
![Клонирование репозитория](/images/clone_repo.jpg)

## **4. Настройка скачанного проекта**

4.1. Активируйте виртуальное окружение и установите необходимые пакеты. Обратите внимание, что файл requirements.txt должен будет содержать пакет `gunicorn`, т.к. wsgi-сервер необходим для развёртывания
```bash
source ../bin/activate
pip install -r requirements.txt
```

4.2. Если в проекте реализовано использование переменных окружения, создайте файл `.env` и внесите в него необходимые переменные. Если же нет, то настройте модуль settings.py.
В ALLOWED_HOSTS укажите и IP адрес и доменное имя.

4.3. Проведите миграции (убедитесь, что виртуальное окружение активно)
```bash
python manage.py migrate
```

4.4. Настройте в settings.py пункт STATIC_ROOT

```python
STATIC_ROOT = os.path.join(BASE_DIR, 'static')
```

4.5. Соберите статику (убедитесь, что виртуальное окружение активно)
```bash
python manage.py collectstatic
```

## **5. Настройка nginx и gunicorn**

Теперь необходимо немного доработать файл настроек gunicorn, чтобы он подключался к нашему проекту. 

5.1. Откройте при помощи текстового редактора nano файл настроек сервиса gunicorn
```bash
sudo nano /etc/systemd/system/gunicorn.service
```

5.2. В открывшемся файле перейдите к строке ExecStart и найдите следующий код `django_project.wsgi:application` и измените `django_project` на название своей директории Django-проекта (это та директория, в которой находятся файлы `asgi.py`, `settings.py`, `urls.py` и `wsgi.py`)
![Настройки gunicorn](/images/gunicorn_settings.jpg)

5.3. Обновите настройки командой
```bash
sudo systemctl daemon-reload
```
и перезапустите сервис gunicorn
```bash
sudo systemctl restart gunicorn
```

5.4. Проверьте в браузере, перейдя по IP адресу и по доменному имени
![Сайт](/images/site.jpg)